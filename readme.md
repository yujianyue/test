# asp多TSV文本数据万用查分系统

一个基于ASP后端和HTML5+CSS3+JS+AJAX的单文件自适应页面实现的多TSV文本数据查询系统。  
参考PHP:fgetcsv读取数据效果，支持单元格规避（制表符、回车换行），避免数据读取的错位。

## 功能特性

- **多文件支持**: 支持多个TSV数据文件，自动扫描并列出可用文件
- **动态查询条件**: 根据选择的文件自动生成查询条件输入框
- **精准查询**: 支持多条件精准匹配（都输对）查询
- **验证码保护**: 可配置的4位图片数字验证码验证
- **分页显示**: 支持大量数据的分页显示
- **多种视图**: 支持横向和竖向表格视图切换
- **图片支持**: 支持图片字段的点击预览
- **隐藏字段**: 支持配置敏感字段隐藏显示
- **链接字段**: 支持链接字段的点击访问确认
- **单元格折叠**: 超过字数自动折叠，支持展开查看
- **响应式设计**: 自适应各种屏幕尺寸，移动端自动切换竖向视图
- **实时反馈**: 查询结果包含执行时间和内存消耗

## 技术栈

- **后端**: ASP (Active Server Pages) + VBScript
- **前端**: HTML5 + CSS3 + JavaScript + AJAX
- **数据格式**: TSV (制表符分隔值)
- **样式**: 现代化渐变设计，响应式布局

## 文件结构

```
.
├── index.asp              # ASP后端主文件（单文件包含所有功能）
├── readme.md              # 介绍及使用说明书
└── shujuku/              # 数据文件目录
    ├── students.xls.dat   # 学生信息数据
    ├── employees.xls.dat  # 员工信息数据
    └── products.xls.dat   # 商品信息数据
```

## 系统配置

在 `index.asp` 文件顶部配置系统参数：

```asp
Title = "多输入框都输对精准查询系统(万用查分)"
Copyr = "查立得-"
Jscss = "V20210909"
Ismas = "1"              '是否启用验证码 (1=是, 0=否)
Baoha = "1"              '是否精准查询 (1=是, 0=否)
Zishu = 32               '超过字数:折叠、展开
Itiao = "姓名|学号|工号"  '查询条件字段(|分隔)
Ihide = "密码|身份证"     '隐藏字段(|分隔)
Isurl = "购买地址|先领优惠券"  '链接字段(|分隔)
Isimg = "商品主图|产品图片"    '图片字段(|分隔)
Dbdir = "./shujuku/"     '数据文件目录
Dbxls = ".xls.dat"       '数据文件后缀
Copyu = "/"              '版权链接
Pagex = 10               '每页显示条数
Pagem = 20               '最大显示页数
```

### 配置说明

- **Title**: 系统标题，显示在页面顶部
- **Copyr**: 版权信息前缀
- **Jscss**: 版本号标识
- **Ismas**: 是否启用验证码（1=启用，0=禁用）
- **Baoha**: 是否精准查询（1=精准匹配，0=模糊匹配）
- **Zishu**: 单元格内容超过此字数时自动折叠
- **Itiao**: 查询条件字段，多个字段用"|"分隔
- **Ihide**: 隐藏字段，查询结果中不显示这些字段
- **Isurl**: 链接字段，这些字段的值会被识别为链接
- **Isimg**: 图片字段，这些字段的值会被识别为图片URL
- **Dbdir**: 数据文件存放目录
- **Dbxls**: 数据文件后缀名
- **Copyu**: 版权链接地址
- **Pagex**: 每页显示的记录条数
- **Pagem**: 分页导航最多显示的页码数量

## 数据文件格式

TSV数据文件需要遵循以下格式：

1. **第1行**: 系统标题
2. **第2行**: 查询标题
3. **第3行**: 字段名（制表符分隔）
4. **第4行开始**: 数据行（制表符分隔）

### 示例（学生信息）

```
学生信息管理系统
学生成绩查询
姓名	学号	班级	语文	数学	英语	总分	排名	联系方式	家庭地址
张三	2023001	高三(1)班	85	92	78	255	15	13800138001	北京市朝阳区
李四	2023002	高三(1)班	92	88	95	275	8	13800138002	上海市浦东新区
王五	2023003	高三(2)班	78	85	82	245	22	13800138003	广州市天河区
```

### 示例（员工信息）

```
员工信息管理系统
员工档案查询
姓名	工号	部门	职位	工资	入职日期	联系方式	身份证	购买地址	商品主图
李明	E001	技术部	软件工程师	12000	2023-01-15	13900139001	110101199001011234	https://shop.example.com/item1	https://img.example.com/product1.jpg
```

### 示例（商品信息）

```
商品信息管理系统
商品查询系统
商品名称	商品编号	分类	价格	库存	供应商	先领优惠券	产品图片	描述
iPhone 15	P001	手机	7999	50	苹果公司	https://coupon.example.com/iphone	https://img.example.com/iphone15.jpg	最新款iPhone手机
```

### 格式要求

1. 文件编码必须是 **UTF-8** 或 **Unicode**
2. 字段之间使用 **制表符（Tab）** 分隔，不是空格
3. 每行数据的字段数量应与表头保持一致
4. 如果字段值为空，仍需保留制表符占位
5. 单元格内的换行和制表符会被正确处理，不会导致数据错位

## 部署说明

### 1. 服务器要求

- Windows Server + IIS（Internet Information Services）
- 支持ASP（Active Server Pages）
- 支持Session会话管理

### 2. IIS配置步骤

1. 打开IIS管理器
2. 创建新网站或使用默认网站
3. 将 `index.asp` 和 `shujuku` 目录放到网站根目录
4. 确保ASP功能已启用：
   - 打开"服务器角色" → "Web服务器(IIS)" → "应用程序开发"
   - 勾选"ASP"选项
5. 设置应用程序池：
   - 启用32位应用程序（如需要）
   - 托管管道模式：经典
6. 设置目录权限：
   - 确保IUSR用户有读取权限
   - 确保应用程序池标识有读取shujuku目录的权限

### 3. 文件权限

```
index.asp       - 读取权限
shujuku/        - 读取权限
  *.xls.dat     - 读取权限
```

### 4. 访问地址

部署完成后，通过浏览器访问：
- `http://your-domain.com/index.asp`
- 或 `http://localhost/index.asp`

## 使用方法

### 1. 选择查询文件

打开系统后，首先从下拉列表中选择要查询的数据文件。系统会自动加载该文件的可用查询字段。

### 2. 输入查询条件

根据系统自动生成的输入框，填写查询条件。

- **精准查询模式**（Baoha=1）: 所有条件必须完全匹配
- **模糊查询模式**（Baoha=0）: 包含关键字即可

### 3. 输入验证码

如果启用了验证码功能，需要输入图片中显示的4位数字。点击验证码图片可刷新。

### 4. 执行查询

点击"查询数据"按钮执行查询，系统会隐藏输入表单并显示查询结果。

### 5. 查看结果

- **横向表格**: 传统的表格视图
- **竖向表格**: 每条记录单独显示，适合移动设备
- **切换视图**: 点击"切换视图"按钮可在两种视图间切换
- **分页浏览**: 使用底部分页导航浏览大量数据
- **图片预览**: 点击图片字段可全屏预览
- **链接访问**: 点击链接字段会弹出确认对话框
- **文本展开**: 点击折叠的长文本可展开查看完整内容

### 6. 关闭结果

点击"关闭结果"按钮可返回查询表单，进行新的查询。

## API接口

系统提供以下API接口（通过AJAX调用）：

### 1. 获取文件列表

**请求方式**: GET  
**接口地址**: `/?do=list`  
**返回格式**: JSON

```json
{
  "success": true,
  "files": [
    {
      "name": "students.xls.dat",
      "display": "students"
    }
  ]
}
```

### 2. 获取文件字段

**请求方式**: GET  
**接口地址**: `/?do=list&file=students.xls.dat`  
**返回格式**: JSON

```json
{
  "success": true,
  "fields": ["姓名", "学号"]
}
```

### 3. 获取验证码

**请求方式**: GET  
**接口地址**: `/?do=code`  
**返回格式**: GIF图片

验证码会保存在Session中，有效期20分钟。

### 4. 执行查询

**请求方式**: POST  
**接口地址**: `/?do=cha`  
**提交参数**:
- `file`: 文件名
- `captcha`: 验证码（如启用）
- 其他查询字段值

**返回格式**: JSON

```json
{
  "success": true,
  "title": "学生信息管理系统",
  "subtitle": "学生成绩查询",
  "headers": ["姓名", "学号", "班级"],
  "data": [
    {
      "姓名": "张三",
      "学号": "2023001",
      "班级": "高三(1)班"
    }
  ],
  "total": 1,
  "time": "0.0234s",
  "memory": "N/A",
  "pagination": {
    "currentPage": 1,
    "totalPages": 1,
    "pageSize": 10
  }
}
```

## 特色功能

### 1. 动态查询条件

系统会根据选择的文件和配置的查询字段（Itiao）自动分析可用的查询字段，并动态生成相应的输入框。只有包含查询关键字的字段才会显示为查询条件。

### 2. 图片预览

对于配置为图片字段的数据（Isimg），系统会：
- 自动将URL渲染为缩略图（100x100px）
- 点击缩略图可全屏预览大图
- 点击背景可关闭预览

### 3. 链接确认

对于配置为链接字段的数据（Isurl），系统会：
- 将字段值显示为带下划线的蓝色链接样式
- 点击时弹出确认对话框，显示完整链接地址
- 确认后在新标签页打开链接

### 4. 字段隐藏

对于配置为隐藏字段的数据（Ihide），系统会：
- 在查询结果中完全隐藏这些字段
- 常用于隐藏敏感信息（如密码、身份证号等）

### 5. 文本折叠

对于超过配置字数（Zishu）的单元格内容，系统会：
- 自动折叠显示，避免表格过宽
- 显示省略号提示有更多内容
- 点击可展开/折叠完整内容

### 6. 响应式设计

界面采用现代化设计，支持各种屏幕尺寸：
- 桌面端：默认横向表格视图
- 移动端（768px以下）：自动切换为竖向卡片视图
- 渐变色背景，圆角卡片，阴影效果
- 平滑的动画过渡

### 7. 实时反馈

查询结果包含以下信息：
- 记录总数
- 当前页码/总页数
- 查询执行时间
- 内存消耗（ASP环境暂不支持，显示N/A）

### 8. Session验证码

系统使用Session存储验证码，特点：
- 每次请求验证码都会生成新的随机4位数字
- 验证码有效期20分钟
- 验证后自动失效，需重新获取

### 9. TSV数据解析

参考PHP的fgetcsv函数，正确处理：
- 制表符分隔符
- 单元格内的换行符
- Unicode和UTF-8编码
- 空字段占位

## 注意事项

### 1. 服务器环境

- 必须在支持ASP的Windows Server + IIS环境下运行
- Linux服务器不支持ASP
- 可以使用本地IIS Express进行开发测试

### 2. 文件编码

- 数据文件必须使用UTF-8或Unicode编码
- 避免使用ANSI或GB2312编码，可能导致中文乱码

### 3. 数据文件

- 文件必须以配置的后缀结尾（默认.xls.dat）
- 文件必须放在配置的目录中（默认./shujuku/）
- 表头字段名不能重复

### 4. 性能优化

- 单个文件不建议超过10000行数据
- 如需处理大量数据，考虑拆分为多个文件
- 启用IIS输出缓存可提高性能

### 5. 安全建议

- 建议启用验证码功能（Ismas=1）
- 配置IIS请求限制，防止暴力查询
- 定期更新服务器安全补丁
- 敏感字段配置到Ihide中隐藏

### 6. 浏览器兼容

- 支持所有现代浏览器（Chrome、Firefox、Safari、Edge）
- IE 11及以下可能存在兼容性问题
- 建议使用最新版本浏览器以获得最佳体验

## 常见问题

### Q1: 验证码显示不出来？

**A**: 检查以下几点：
- IIS是否启用了ASP功能
- Session是否正常工作
- 浏览器是否禁用了Cookie

### Q2: 中文显示乱码？

**A**: 确保：
- 数据文件使用UTF-8编码保存
- index.asp文件头部有正确的编码声明
- IIS站点配置的默认编码为UTF-8

### Q3: 查询没有结果？

**A**: 检查：
- 查询条件是否完全正确（精准查询模式）
- 数据文件格式是否正确
- 字段名是否与表头一致

### Q4: 图片不显示？

**A**: 确认：
- 图片URL是否正确
- 图片服务器是否允许跨域访问
- 字段名是否配置在Isimg中

### Q5: 无法上传或修改数据？

**A**: 本系统是只读查询系统，不支持数据修改。如需修改数据，请直接编辑TSV文件。

## 扩展开发

### 1. 添加新的数据文件

1. 按照TSV格式准备数据文件
2. 文件名以 `.xls.dat` 结尾
3. 放入 `shujuku` 目录
4. 系统会自动扫描并列出

### 2. 自定义样式

修改 `index.asp` 中的 `<style>` 标签内的CSS：
- 修改渐变色：`.header` 的 `background`
- 修改按钮颜色：`.btn` 的 `background`
- 修改字体：`body` 的 `font-family`

### 3. 扩展功能

可以在现有基础上添加：
- 数据导出（CSV、Excel）
- 高级筛选（日期范围、数值范围）
- 排序功能
- 查询历史记录
- 用户权限管理

### 4. 数据库集成

如需支持更大数据量，可改造为连接数据库：
- 修改 `ReadTSVFile` 函数为数据库查询
- 修改 `FilterData` 函数为SQL WHERE条件
- 保持前端接口不变

## 技术支持

如有问题或建议，欢迎反馈！

## 许可证

本项目采用MIT许可证，可自由使用和修改。

---

**版本**: V20210909  
**更新日期**: 2025-11-14  
**作者**: 查立得
